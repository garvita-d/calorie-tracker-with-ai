<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI-Powered Voice Calorie Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .ai-badge {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 10px;
        }

        /* Dietary Preferences Section */
        .diet-preference-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .diet-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .diet-modal-content h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .diet-option {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 40px;
            margin: 10px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .diet-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .diet-indicator {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .voice-section {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .voice-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .voice-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .voice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-btn.listening {
            background: rgba(255, 255, 255, 0.4);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status {
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .rephrase-btn {
            background: linear-gradient(135deg, #ff9a8b, #ffa726);
            margin-left: 10px;
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .daily-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .recommendations {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .recommendations h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .food-card {
            background: linear-gradient(135deg, #a8e6cf, #88d8a3);
            padding: 15px;
            border-radius: 10px;
            color: #2d5016;
        }

        .food-card.veg {
            background: linear-gradient(135deg, #a8e6cf, #88d8a3);
        }

        .food-card.non-veg {
            background: linear-gradient(135deg, #ffb3ba, #ff6b6b);
            color: #5d1a1a;
        }

        .food-card h4 {
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .food-card p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .meal-log {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
        }

        .meal-log h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .meal-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meal-info {
            flex: 1;
        }

        .meal-calories {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .ai-analysis {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #0c5460;
        }

        .rephrase-area {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .daily-stats {
                grid-template-columns: 1fr;
            }

            .diet-modal-content {
                padding: 30px 20px;
            }

            .diet-option {
                display: block;
                margin: 10px 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Dietary Preference Modal -->
    <div id="dietModal" class="diet-preference-modal">
        <div class="diet-modal-content">
            <h2>🍽️ Choose Your Dietary Preference</h2>
            <p style="margin-bottom: 30px; color: #666;">This helps us provide better food recommendations and accurate calorie analysis</p>
            <button class="diet-option" onclick="setDietPreference('vegetarian')">
                🌱 Vegetarian
            </button>
            <button class="diet-option" onclick="setDietPreference('non-vegetarian')">
                🍖 Non-Vegetarian
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🤖 Enhanced AI Calorie Tracker</h1>
            <p>AI-powered food recognition with accurate calorie counting</p>
            <div class="ai-badge">✨ Powered by AI & Google</div>
            <div id="dietIndicator" class="diet-indicator" style="display: none;">
                <span id="dietType"></span>
            </div>
        </div>

        <div class="voice-section">
            <h3>🗣️ Voice Input</h3>
            <button id="voiceBtn" class="voice-btn">🎙️ Start Voice Recognition</button>
            <button id="stopBtn" class="voice-btn" style="display: none;">⏹️ Stop Listening</button>
            <div id="voiceStatus" class="status">Click to start speaking</div>
            <div id="voiceResult" style="margin-top: 15px; font-style: italic;"></div>
        </div>

        <div class="input-section">
            <h3>✏️ Manual Input (Alternative)</h3>
            <div class="input-group">
                <input type="text" id="foodInput" placeholder="Describe any food in any way (e.g., 'had pizza for lunch', 'ate mom's homemade biryani')">
                <button class="btn" id="analyzeBtn" onclick="processFoodInput()">
                    <span id="btnText">Analyze Food</span>
                </button>
                <button class="btn rephrase-btn" id="rephraseBtn" onclick="rephraseInput()">
                    🔄 Rephrase
                </button>
            </div>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                Examples: "Two slices of pizza", "Mom's chicken curry with rice", "Starbucks latte and muffin"
            </p>
            <div id="rephraseArea" class="rephrase-area" style="display: none;">
                <h4>🔄 AI Rephrased Suggestions:</h4>
                <div id="rephrasedOptions"></div>
            </div>
        </div>

        <div id="messageArea"></div>

        <div class="daily-stats">
            <div class="stat-card">
                <h3>Daily Target</h3>
                <div class="number" id="targetCals">2000</div>
                <p>calories</p>
            </div>
            <div class="stat-card">
                <h3>Consumed</h3>
                <div class="number" id="consumedCals">0</div>
                <p>calories</p>
            </div>
            <div class="stat-card">
                <h3>Remaining</h3>
                <div class="number" id="remainingCals">2000</div>
                <p>calories</p>
            </div>
        </div>

        <div class="recommendations">
            <h3>💡 AI-Powered Recommendations</h3>
            <div id="recommendationsArea">
                <p>Add some food items to get personalized AI recommendations based on your dietary preference!</p>
            </div>
        </div>

        <div class="meal-log">
            <h3>📝 Today's Meals</h3>
            <div id="mealLog">
                <p style="color: #666;">No meals logged today. Start by describing any food you've eaten!</p>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let dailyCalories = 0;
        let dailyTarget = 2000;
        let mealLog = [];
        let recognition = null;
        let isListening = false;
        let isProcessing = false;
        let dietPreference = null;
        let lastInput = '';

        // Dietary Preferences
        function setDietPreference(preference) {
            dietPreference = preference;
            document.getElementById('dietModal').style.display = 'none';
            document.getElementById('dietIndicator').style.display = 'inline-block';
            document.getElementById('dietType').textContent = 
                preference === 'vegetarian' ? '🌱 Vegetarian' : '🍖 Non-Vegetarian';
            
            updateRecommendations();
            showMessage(`✅ Dietary preference set to ${preference}. Recommendations updated!`, 'success');
        }

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceStatus('🎤 Listening... Speak now!', 'listening');
                    document.getElementById('voiceBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                };
                
                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            transcript = event.results[i][0].transcript;
                        }
                    }
                    
                    if (transcript) {
                        document.getElementById('voiceResult').innerHTML = `<strong>You said:</strong> "${transcript}"`;
                        lastInput = transcript;
                        processFoodInput(transcript);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    updateVoiceStatus('❌ Error: ' + event.error, 'error');
                    resetVoiceButtons();
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateVoiceStatus('✅ Voice recognition stopped', 'success');
                    resetVoiceButtons();
                };
                
                return true;
            } else {
                updateVoiceStatus('❌ Voice recognition not supported in this browser', 'error');
                return false;
            }
        }

        function startVoiceRecognition() {
            if (isProcessing) {
                showMessage('Please wait for current analysis to complete', 'warning');
                return;
            }

            if (!recognition) {
                if (!initSpeechRecognition()) {
                    return;
                }
            }
            
            if (!isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    updateVoiceStatus('❌ Failed to start voice recognition', 'error');
                }
            }
        }

        function stopVoiceRecognition() {
            if (recognition && isListening) {
                recognition.stop();
            }
        }

        function updateVoiceStatus(message, type = '') {
            const statusEl = document.getElementById('voiceStatus');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function resetVoiceButtons() {
            document.getElementById('voiceBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }

        // Enhanced AI Food Analysis with Google Integration Simulation
        async function analyzeFood(foodDescription) {
            // Simulate Google AI/Nutritionix API call for comprehensive food analysis
            const prompt = `Analyze this food description with dietary preference (${dietPreference}): "${foodDescription}"
            
            Provide detailed nutritional information including calories, macronutrients, and dietary compatibility.`;

            return await simulateAdvancedAIResponse(foodDescription);
        }

        function simulateAdvancedAIResponse(foodDescription) {
            const description = foodDescription.toLowerCase();
            const foods = [];
            let totalCalories = 0;
            
            // Comprehensive food database (simulating Google/AI response)
            const comprehensiveFoodDB = {
                // Vegetarian foods
                'pizza': { base: 266, type: 'mixed', variations: { 'slice': 0.5, 'large': 1.5, 'small': 0.7, 'margherita': 0.9, 'veggie': 0.8 } },
                'veggie burger': { base: 390, type: 'vegetarian', variations: { 'small': 0.8, 'large': 1.3 } },
                'biryani': { base: 290, type: 'mixed', variations: { 'veg': 0.8, 'chicken': 1.2, 'mutton': 1.4, 'plate': 1.5 } },
                'rice': { base: 130, type: 'vegetarian', variations: { 'cup': 1, 'bowl': 1.2, 'plate': 1.5, 'fried': 1.3 } },
                'dal': { base: 115, type: 'vegetarian', variations: { 'cup': 1, 'bowl': 1.2, 'tadka': 1.3 } },
                'roti': { base: 71, type: 'vegetarian', variations: { 'chapati': 1, 'butter': 1.4 } },
                'naan': { base: 262, type: 'vegetarian', variations: { 'butter': 1.2, 'garlic': 1.1 } },
                'paneer': { base: 321, type: 'vegetarian', variations: { 'curry': 1, 'tikka': 0.9, 'butter masala': 1.3, 'makhani': 1.4 } },
                'pasta': { base: 131, type: 'vegetarian', variations: { 'plate': 2, 'bowl': 1.5, 'alfredo': 2.5, 'marinara': 1.8 } },
                'salad': { base: 33, type: 'vegetarian', variations: { 'caesar': 4, 'garden': 1, 'greek': 3 } },
                'sandwich': { base: 200, type: 'mixed', variations: { 'club': 1.5, 'grilled cheese': 1.2, 'veg': 0.9 } },
                'samosa': { base: 91, type: 'vegetarian', variations: { 'aloo': 1, 'large': 1.3 } },
                'dosa': { base: 133, type: 'vegetarian', variations: { 'masala': 1.2, 'plain': 1, 'rava': 1.1 } },
                'idli': { base: 39, type: 'vegetarian', variations: { 'piece': 1, 'rava': 1.2 } },
                'poha': { base: 180, type: 'vegetarian', variations: { 'bowl': 1, 'plate': 1.3 } },
                'upma': { base: 200, type: 'vegetarian', variations: { 'bowl': 1, 'rava': 1 } },
                
                // Non-vegetarian foods
                'chicken': { base: 165, type: 'non-vegetarian', variations: { 'curry': 1.8, 'tikka': 1.2, 'fried': 2.2, 'grilled': 1, 'butter': 2.5 } },
                'mutton': { base: 294, type: 'non-vegetarian', variations: { 'curry': 1.5, 'biryani': 1.3, 'kebab': 1.2 } },
                'fish': { base: 206, type: 'non-vegetarian', variations: { 'curry': 1.3, 'fried': 1.8, 'grilled': 1, 'fry': 1.6 } },
                'egg': { base: 68, type: 'non-vegetarian', variations: { 'boiled': 1, 'fried': 1.5, 'scrambled': 1.3, 'omelette': 1.8 } },
                'prawn': { base: 99, type: 'non-vegetarian', variations: { 'curry': 1.5, 'fried': 1.8 } },
                'beef': { base: 250, type: 'non-vegetarian', variations: { 'curry': 1.4, 'steak': 1.2 } },
                'burger': { base: 540, type: 'non-vegetarian', variations: { 'chicken': 1, 'beef': 1.2, 'fish': 0.9 } },
                
                // Beverages
                'coffee': { base: 2, type: 'vegetarian', variations: { 'black': 1, 'latte': 25, 'cappuccino': 15, 'mocha': 35 } },
                'tea': { base: 2, type: 'vegetarian', variations: { 'plain': 1, 'chai': 8, 'milk': 10, 'green': 1 } },
                'juice': { base: 45, type: 'vegetarian', variations: { 'orange': 1.2, 'apple': 1.1, 'mango': 1.4 } },
                
                // Snacks and sweets
                'chips': { base: 152, type: 'vegetarian', variations: { 'packet': 3, 'small': 1 } },
                'chocolate': { base: 50, type: 'vegetarian', variations: { 'bar': 5, 'piece': 1, 'dark': 0.9 } },
                'ice cream': { base: 137, type: 'vegetarian', variations: { 'scoop': 1, 'cup': 1.5 } },
                'cake': { base: 257, type: 'vegetarian', variations: { 'slice': 1, 'piece': 1, 'chocolate': 1.2 } }
            };

            // Extract quantities with better pattern matching
            const quantityPatterns = [
                { regex: /(\d+)\s*(piece|pieces|slice|slices|serving|servings)/i, multiplier: 1 },
                { regex: /(\d+)\s*(cup|cups|bowl|bowls|glass|glasses)/i, multiplier: 1 },
                { regex: /(\d+)\s*(plate|plates|portion|portions)/i, multiplier: 1 },
                { regex: /(one|a|an)\s/i, multiplier: 1, quantity: 1 },
                { regex: /(two|couple)\s/i, multiplier: 1, quantity: 2 },
                { regex: /(three)\s/i, multiplier: 1, quantity: 3 },
                { regex: /(half|1\/2)\s/i, multiplier: 0.5, quantity: 1 },
                { regex: /(quarter|1\/4)\s/i, multiplier: 0.25, quantity: 1 }
            ];

            // Analyze each food in the comprehensive database
            Object.keys(comprehensiveFoodDB).forEach(foodName => {
                if (description.includes(foodName)) {
                    const foodData = comprehensiveFoodDB[foodName];
                    
                    // Skip non-vegetarian foods for vegetarians
                    if (dietPreference === 'vegetarian' && foodData.type === 'non-vegetarian') {
                        return;
                    }
                    
                    let quantity = 1;
                    let multiplier = 1;
                    
                    // Find quantity
                    for (let pattern of quantityPatterns) {
                        const match = description.match(pattern.regex);
                        if (match) {
                            quantity = pattern.quantity || parseInt(match[1]) || 1;
                            if (pattern.multiplier) multiplier *= pattern.multiplier;
                            break;
                        }
                    }
                    
                    // Find variations
                    Object.keys(foodData.variations).forEach(variation => {
                        if (description.includes(variation)) {
                            multiplier *= foodData.variations[variation];
                        }
                    });
                    
                    const calories = Math.round(foodData.base * quantity * multiplier);
                    totalCalories += calories;
                    
                    foods.push({
                        name: foodName.charAt(0).toUpperCase() + foodName.slice(1),
                        quantity: `${quantity} ${quantity > 1 ? 'servings' : 'serving'}`,
                        calories: calories,
                        confidence: 'high',
                        type: foodData.type
                    });
                }
            });

            // If no specific foods found, use AI-like general estimation
            if (foods.length === 0) {
                const generalEstimate = estimateGeneralCalories(description);
                totalCalories = generalEstimate.calories;
                foods.push(generalEstimate.food);
            }

            // Add dietary preference note
            let dietaryNote = '';
            if (dietPreference === 'vegetarian') {
                const nonVegCount = foods.filter(f => f.type === 'non-vegetarian').length;
                if (nonVegCount > 0) {
                    dietaryNote = ' Note: Some items may not align with your vegetarian preference.';
                }
            }

            return {
                foods: foods,
                totalCalories: totalCalories,
                analysis: `🤖 AI analysis complete using advanced food recognition. Identified ${foods.length} food item(s) with ${dietPreference} dietary preferences considered.${dietaryNote}`
            };
        }

        function estimateGeneralCalories(description) {
            // AI-like estimation for unknown foods
            const mealTypes = {
                'breakfast': { base: 300, multiplier: 1 },
                'lunch': { base: 500, multiplier: 1 },
                'dinner': { base: 600, multiplier: 1 },
                'snack': { base: 150, multiplier: 1 }
            };

            let estimatedCalories = 400; // Default moderate estimate
            let foodType = 'mixed';

            // Check for meal type context
            Object.keys(mealTypes).forEach(meal => {
                if (description.includes(meal)) {
                    estimatedCalories = mealTypes[meal].base;
                }
            });

            // Adjust for dietary preference
            if (dietPreference === 'vegetarian') {
                foodType = 'vegetarian';
                estimatedCalories *= 0.85; // Vegetarian foods tend to be lower calorie
            }

            // Adjust for descriptive words
            if (description.includes('large') || description.includes('big') || description.includes('heavy')) {
                estimatedCalories *= 1.5;
            } else if (description.includes('small') || description.includes('light')) {
                estimatedCalories *= 0.7;
            }

            return {
                food: {
                    name: 'General Food Item',
                    quantity: '1 serving (estimated)',
                    calories: Math.round(estimatedCalories),
                    confidence: 'moderate',
                    type: foodType
                },
                calories: Math.round(estimatedCalories)
            };
        }

        // Rephrase functionality
        async function rephraseInput() {
            const input = document.getElementById('foodInput').value.trim() || lastInput;
            if (!input) {
                showMessage('Please enter some food description first', 'warning');
                return;
            }

            const rephraseArea = document.getElementById('rephraseArea');
            const rephrasedOptions = document.getElementById('rephrasedOptions');
            
            // Simulate AI rephrasing
            const rephrasedSuggestions = generateRephrasedSuggestions(input);
            
            let optionsHtml = '';
            rephrasedSuggestions.forEach((suggestion, index) => {
                optionsHtml += `
                    <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                        <button class="btn" style="margin-right: 10px; padding: 5px 15px; font-size: 0.9em;" 
                                onclick="useRephrasedInput('${suggestion}')">Use This</button>
                        "${suggestion}"
                    </div>
                `;
            });
            
            rephrasedOptions.innerHTML = optionsHtml;
            rephraseArea.style.display = 'block';
        }

        function generateRephrasedSuggestions(input) {
            const suggestions = [];
            const original = input.toLowerCase();

            // Add quantity if missing
            if (!original.match(/\d+|one|two|three|half|quarter/)) {
                suggestions.push(`One serving of ${input}`);
                suggestions.push(`Two portions of ${input}`);
            }

            // Add meal context
            suggestions.push(`Had ${input} for lunch`);
            suggestions.push(`Ate ${input} as a snack`);

            // Add descriptive words
            suggestions.push(`Medium sized ${input}`);
            suggestions.push(`Homemade ${input}`);

            return suggestions.slice(0, 4); // Return max 4 suggestions
        }

        function useRephrasedInput(suggestion) {
            document.getElementById('foodInput').value = suggestion;
            document.getElementById('rephraseArea').style.display = 'none';
            processFoodInput(suggestion);
        }

        // Main food processing function
        async function processFoodInput(voiceInput = null) {
            if (isProcessing) {
                showMessage('Please wait for current analysis to complete', 'warning');
                return;
            }

            const input = voiceInput || document.getElementById('foodInput').value.trim();
            
            if (!input) {
                showMessage('Please describe some food first!', 'warning');
                return;
            }

            if (!dietPreference) {
                showMessage('Please set your dietary preference first!', 'warning');
                document.getElementById('dietModal').style.display = 'flex';
                return;
            }

            isProcessing = true;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            
            // Update button to show loading
            analyzeBtn.disabled = true;
            btnText.innerHTML = '<div class="loading"></div>Analyzing...';

            try {
                const result = await analyzeFood(input);
                
                if (result.foods && result.foods.length > 0) {
                    // Add to meal log
                    const timestamp = new Date().toLocaleTimeString();
                    const mealEntry = {
                        timestamp: timestamp,
                        description: input,
                        foods: result.foods,
                        totalCalories: result.totalCalories,
                        analysis: result.analysis
                    };
                    
                    mealLog.push(mealEntry);
                    dailyCalories += result.totalCalories;
                    
                    // Update UI
                    updateDailyStats();
                    updateMealLog();
                    updateRecommendations();
                    
                    // Show success message with analysis
                    showMessage(`✅ Analysis complete! Added ${result.totalCalories} calories to your daily intake.`, 'success');
                    
                    // Show AI analysis
                    showMessage(result.analysis, 'info');
                    
                    // Clear input
                    if (!voiceInput) {
                        document.getElementById('foodInput').value = '';
                    }
                    
                } else {
                    showMessage('❌ Could not analyze the food. Please try describing it differently.', 'error');
                }
                
            } catch (error) {
                console.error('Error analyzing food:', error);
                showMessage('❌ Error analyzing food. Please try again.', 'error');
            } finally {
                isProcessing = false;
                analyzeBtn.disabled = false;
                btnText.textContent = 'Analyze Food';
            }
        }

        // UI Update Functions
        function updateDailyStats() {
            document.getElementById('consumedCals').textContent = dailyCalories;
            document.getElementById('remainingCals').textContent = Math.max(0, dailyTarget - dailyCalories);
            
            // Update color based on progress
            const consumedEl = document.getElementById('consumedCals');
            const remainingEl = document.getElementById('remainingCals');
            
            if (dailyCalories > dailyTarget * 1.1) {
                consumedEl.style.color = '#ff6b6b';
                remainingEl.style.color = '#ff6b6b';
            } else if (dailyCalories > dailyTarget * 0.8) {
                consumedEl.style.color = '#ffa726';
                remainingEl.style.color = '#ffa726';
            } else {
                consumedEl.style.color = '#4facfe';
                remainingEl.style.color = '#4facfe';
            }
        }

        function updateMealLog() {
            const mealLogEl = document.getElementById('mealLog');
            
            if (mealLog.length === 0) {
                mealLogEl.innerHTML = '<p style="color: #666;">No meals logged today. Start by describing any food you\'ve eaten!</p>';
                return;
            }
            
            let logHtml = '';
            mealLog.reverse().forEach((meal, index) => {
                logHtml += `
                    <div class="meal-item">
                        <div class="meal-info">
                            <strong>${meal.description}</strong>
                            <br>
                            <small style="color: #666;">${meal.timestamp} - ${meal.foods.length} item(s)</small>
                            <div class="ai-analysis">${meal.analysis}</div>
                            <div style="margin-top: 8px;">
                                ${meal.foods.map(food => `
                                    <span style="background: ${food.type === 'vegetarian' ? '#a8e6cf' : food.type === 'non-vegetarian' ? '#ffb3ba' : '#e3f2fd'}; 
                                          color: ${food.type === 'vegetarian' ? '#2d5016' : food.type === 'non-vegetarian' ? '#5d1a1a' : '#1565c0'}; 
                                          padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px;">
                                        ${food.name}: ${food.calories} cal
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        <div class="meal-calories">${meal.totalCalories} cal</div>
                    </div>
                `;
            });
            mealLog.reverse(); // Restore original order
            
            mealLogEl.innerHTML = logHtml;
        }

        function updateRecommendations() {
            const recommendationsEl = document.getElementById('recommendationsArea');
            
            if (mealLog.length === 0) {
                recommendationsEl.innerHTML = '<p>Add some food items to get personalized AI recommendations based on your dietary preference!</p>';
                return;
            }
            
            const recommendations = generateRecommendations();
            let recommendationsHtml = '';
            
            recommendations.forEach(rec => {
                recommendationsHtml += `
                    <div class="food-card ${rec.type}">
                        <h4>${rec.name}</h4>
                        <p>${rec.description}</p>
                        <small>~${rec.calories} calories | ${rec.reason}</small>
                    </div>
                `;
            });
            
            recommendationsEl.innerHTML = `
                <div class="food-grid">${recommendationsHtml}</div>
            `;
        }

        function generateRecommendations() {
            const remainingCals = dailyTarget - dailyCalories;
            const recommendations = [];
            
            // Vegetarian recommendations
            const vegRecommendations = [
                { name: 'Mixed Vegetable Salad', calories: 150, description: 'Light and nutritious with olive oil dressing', reason: 'Low calorie, high nutrients' },
                { name: 'Quinoa Bowl', calories: 220, description: 'Protein-rich quinoa with vegetables', reason: 'Complete protein source' },
                { name: 'Greek Yogurt with Berries', calories: 120, description: 'Probiotic-rich with antioxidants', reason: 'Healthy snack option' },
                { name: 'Vegetable Soup', calories: 100, description: 'Warm and filling with mixed vegetables', reason: 'Hydrating and low calorie' },
                { name: 'Avocado Toast', calories: 200, description: 'Whole grain bread with fresh avocado', reason: 'Healthy fats and fiber' },
                { name: 'Smoothie Bowl', calories: 180, description: 'Fruit smoothie with nuts and seeds', reason: 'Nutrient dense breakfast' }
            ];
            
            // Non-vegetarian recommendations
            const nonVegRecommendations = [
                { name: 'Grilled Chicken Salad', calories: 250, description: 'Lean protein with mixed greens', reason: 'High protein, low carb' },
                { name: 'Fish Tacos', calories: 300, description: 'Grilled fish with fresh salsa', reason: 'Omega-3 rich protein' },
                { name: 'Egg White Omelette', calories: 150, description: 'With vegetables and herbs', reason: 'Low calorie protein' },
                { name: 'Turkey Sandwich', calories: 280, description: 'Lean turkey on whole grain bread', reason: 'Balanced macronutrients' },
                { name: 'Grilled Salmon', calories: 350, description: 'With steamed vegetables', reason: 'Heart-healthy omega-3s' },
                { name: 'Chicken Soup', calories: 200, description: 'Homemade with vegetables', reason: 'Comfort food with protein' }
            ];
            
            let availableRecs = dietPreference === 'vegetarian' ? vegRecommendations : 
                               [...vegRecommendations, ...nonVegRecommendations];
            
            // Filter based on remaining calories
            if (remainingCals < 200) {
                availableRecs = availableRecs.filter(rec => rec.calories <= remainingCals + 50);
            }
            
            // Add type property
            availableRecs.forEach(rec => {
                rec.type = nonVegRecommendations.includes(rec) ? 'non-veg' : 'veg';
            });
            
            // Return random 4 recommendations
            const shuffled = availableRecs.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 4);
        }

        // Utility Functions
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageArea.appendChild(messageDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Event Listeners
        document.getElementById('voiceBtn').addEventListener('click', startVoiceRecognition);
        document.getElementById('stopBtn').addEventListener('click', stopVoiceRecognition);
        
        document.getElementById('foodInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processFoodInput();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if diet preference is already set
            if (!dietPreference) {
                document.getElementById('dietModal').style.display = 'flex';
            }
            
            // Initialize speech recognition
            if (!initSpeechRecognition()) {
                document.querySelector('.voice-section').style.display = 'none';
            }
            
            updateDailyStats();
            updateRecommendations();
        });
    </script>
</body>
</html>